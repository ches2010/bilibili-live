<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Bç«™ç›´æ’­å·¥å…·é›†</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <style>
        .stream-url { word-break: break-all; font-size: 0.9em; margin-top: 6px; }
        .player-container { margin-top: 20px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #f5f5f5; }
        .player-video { width: 100%; max-height: 60vh; background: #000; }
        .copy-btn, .play-btn, .screenshot-btn, .download-btn { margin: 4px 4px 4px 0; }
        .room-header { display: flex; align-items: flex-start; gap: 20px; margin-top: 20px; }
        .room-cover { width: 240px; height: 135px; object-fit: cover; border-radius: 6px; }
        .avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; }
        .status-live { color: #48c774; font-weight: bold; }
        .status-off { color: #ff3860; }
        .status-replay { color: #ffdd57; }
        footer { margin-top: 30px; text-align: center; color: #888; font-size: 0.9em; }
        .tab-content { margin-top: 20px; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        .images-container { display: flex; flex-wrap: wrap; gap: 30px; margin-top: 20px; }
        .image-section { flex: 1; min-width: 300px; text-align: center; }
        .live-image { max-width: 100%; max-height: 500px; border-radius: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin: 0 auto; display: block; }
        .image-info { margin-top: 10px; font-size: 14px; color: #666; }
        .status-indicator { display: inline-block; padding: 5px 10px; border-radius: 15px; font-size: 14px; font-weight: bold; margin-left: 10px; }
        .live { background-color: #e74c3c; color: white; }
        .offline { background-color: #95a5a6; color: white; }
        .round { background-color: #f39c12; color: white; }
    </style>
</head>
<body>
<div class="container">
    <section class="section">
        <h1 class="title is-3 has-text-centered">Bç«™ç›´æ’­å·¥å…·é›†</h1>
        
        <!-- æ ‡ç­¾åˆ‡æ¢ -->
        <div class="tabs is-centered">
            <ul>
                <li class="is-active" data-tab="stream-tab"><a>ç›´æ’­æµæ’­æ”¾</a></li>
                <li data-tab="image-tab"><a>å°é¢ä¸æˆªå›¾</a></li>
            </ul>
        </div>

        <!-- ç›´æ’­æµæ’­æ”¾æ ‡ç­¾å†…å®¹ -->
        <div id="stream-tab" class="tab-pane active">
            <div class="field has-addons">
                <div class="control is-expanded">
                    <input id="roomId" class="input" type="text" placeholder="è¾“å…¥ç›´æ’­é—´å·ç ï¼Œä¾‹å¦‚ï¼š21574414" />
                </div>
                <div class="control">
                    <button id="queryBtn" class="button is-primary">æŸ¥è¯¢</button>
                </div>
            </div>

            <div id="loading" class="is-hidden mt-3">
                <progress class="progress is-small is-info" max="100"></progress>
            </div>

            <div id="roomInfo" class="mt-4"></div>
            <div id="result" class="mt-4"></div>
            <div id="playerArea" class="mt-4"></div>
            <div id="screenshotArea" class="mt-4"></div>
        </div>

        <!-- å°é¢ä¸æˆªå›¾æ ‡ç­¾å†…å®¹ -->
        <div id="image-tab" class="tab-pane">
            <div class="field has-addons">
                <div class="control is-expanded">
                    <input type="text" id="roomIdInput" class="input" placeholder="è¯·è¾“å…¥Bç«™ç›´æ’­é—´IDï¼ˆå¦‚ï¼š31266282ï¼‰">
                </div>
                <div class="control">
                    <button id="fetchBtn" class="button is-primary">è·å–ç›´æ’­ä¿¡æ¯</button>
                </div>
            </div>
            
            <div class="loading" id="imageLoading" style="display: none;">
                <progress class="progress is-small is-info" max="100"></progress>
                <p class="has-text-centered">æ­£åœ¨è·å–ç›´æ’­ä¿¡æ¯...</p>
            </div>
            
            <div id="messageContainer" class="mt-4"></div>
            
            <div class="result-container" id="resultContainer" style="display: none;">
                <div class="box">
                    <h3 class="title is-5">ç›´æ’­ä¿¡æ¯</h3>
                    <div class="info-item">
                        <strong>ç›´æ’­é—´æ ‡é¢˜:</strong> <span id="titleDisplay"></span>
                    </div>
                    <div class="info-item">
                        <strong>ä¸»æ’­ç”¨æˆ·å:</strong> <span id="unameDisplay"></span>
                    </div>
                    <div class="info-item">
                        <strong>æˆ¿é—´ID:</strong> <span id="imageRoomIdDisplay"></span>
                    </div>
                    <div class="info-item">
                        <strong>ç›´æ’­çŠ¶æ€:</strong> 
                        <span id="statusDisplay"></span>
                        <span id="statusIndicator" class="status-indicator"></span>
                    </div>
                    <div class="info-item">
                        <strong>å¼€æ’­æ—¶é—´:</strong> <span id="liveTimeDisplay"></span>
                    </div>
                </div>
                
                <div class="images-container">
                    <!-- å°é¢å›¾ç‰‡åŒºåŸŸ -->
                    <div class="image-section">
                        <div class="image-title">ç›´æ’­é—´å°é¢</div>
                        <img id="coverImage" class="live-image" alt="ç›´æ’­å°é¢">
                        <div class="image-info" id="coverImageInfo"></div>
                        <button class="button is-info download-btn" id="downloadCoverBtn">ä¸‹è½½å°é¢</button>
                    </div>
                    
                    <!-- ç›´æ’­æˆªå›¾åŒºåŸŸ -->
                    <div class="image-section">
                        <div class="image-title">å½“å‰ç›´æ’­ç”»é¢æˆªå›¾</div>
                        <img id="screenshotImage" class="live-image" alt="ç›´æ’­æˆªå›¾">
                        <div class="image-info" id="screenshotImageInfo"></div>
                        <button class="button is-info download-btn" id="downloadScreenshotBtn">ä¸‹è½½æˆªå›¾</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <p>ğŸ’¡ FLV å»¶è¿Ÿæœ€ä½ï¼ŒHLS å…¼å®¹æ€§æœ€å¥½ã€‚æˆªå›¾éœ€å…ˆæ’­æ”¾è§†é¢‘ã€‚</p>
    </footer>
</div>

<!-- æ’­æ”¾å™¨åº“ -->
<script src="https://cdn.jsdelivr.net/npm/flv.js@1.5.1/dist/flv.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.10/dist/hls.min.js"></script>
<script>
    // æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
    document.querySelectorAll('.tabs li').forEach(tab => {
        tab.addEventListener('click', () => {
            // ç§»é™¤æ‰€æœ‰æ´»è·ƒçŠ¶æ€
            document.querySelectorAll('.tabs li').forEach(t => t.classList.remove('is-active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            
            // è®¾ç½®å½“å‰æ´»è·ƒçŠ¶æ€
            tab.classList.add('is-active');
            const tabId = tab.getAttribute('data-tab');
            document.getElementById(tabId).classList.add('active');
        });
    });

    // ç›´æ’­æµæ’­æ”¾ç›¸å…³å˜é‡å’Œå‡½æ•°
    let currentPlayer = null;
    let currentVideo = null;

    function destroyPlayer() {
        if (currentPlayer) {
            if (typeof currentPlayer.destroy === 'function') currentPlayer.destroy();
            currentPlayer = null;
        }
        currentVideo = null;
        document.getElementById('playerArea').innerHTML = '';
        document.getElementById('screenshotArea').innerHTML = '';
    }

    function playFLV(url) {
        destroyPlayer();
        const container = document.getElementById('playerArea');
        const video = document.createElement('video');
        video.className = 'player-video';
        video.controls = true;
        video.playsInline = true;
        video.muted = false;
        currentVideo = video;

        const box = document.createElement('div');
        box.className = 'player-container';
        box.innerHTML = '<strong>æ­£åœ¨æ’­æ”¾ FLV æµ</strong>';
        box.appendChild(video);
        container.appendChild(box);

        if (flvjs.isSupported()) {
            const player = flvjs.createPlayer({ type: 'flv', url });
            player.attachMediaElement(video);
            player.load();
            player.play().catch(e => console.warn('æ’­æ”¾è¢«é˜»æ­¢:', e));
            currentPlayer = player;
        } else {
            alert('æµè§ˆå™¨ä¸æ”¯æŒ FLV');
        }
    }

    function playHLS(url) {
        destroyPlayer();
        const container = document.getElementById('playerArea');
        const video = document.createElement('video');
        video.className = 'player-video';
        video.controls = true;
        video.playsInline = true;
        video.muted = false;
        currentVideo = video;

        const box = document.createElement('div');
        box.className = 'player-container';
        box.innerHTML = '<strong>æ­£åœ¨æ’­æ”¾ HLS æµ</strong>';
        box.appendChild(video);
        container.appendChild(box);

        if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(e => console.warn('æ’­æ”¾è¢«é˜»æ­¢:', e)));
            currentPlayer = hls;
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = url;
            video.addEventListener('loadedmetadata', () => video.play().catch(e => console.warn('æ’­æ”¾è¢«é˜»æ­¢:', e)));
            currentPlayer = { destroy: () => video.src = '' };
        } else {
            alert('æµè§ˆå™¨ä¸æ”¯æŒ HLS');
        }
    }

    function takeScreenshot() {
        if (!currentVideo || currentVideo.readyState < 2) {
            alert('è¯·å…ˆæ’­æ”¾è§†é¢‘å¹¶ç­‰å¾…åŠ è½½ï¼');
            return;
        }

        const canvas = document.createElement('canvas');
        canvas.width = currentVideo.videoWidth;
        canvas.height = currentVideo.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(currentVideo, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(blob => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bili-live-${Date.now()}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 'image/png');
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => alert('å·²å¤åˆ¶ï¼')).catch(() => alert('å¤åˆ¶å¤±è´¥'));
    }

    // ç›´æ’­æµæŸ¥è¯¢æŒ‰é’®äº‹ä»¶
    document.getElementById('queryBtn').addEventListener('click', async () => {
        const roomId = document.getElementById('roomId').value.trim();
        if (!roomId) return alert('è¯·è¾“å…¥æˆ¿é—´å·');

        const roomInfoDiv = document.getElementById('roomInfo');
        const resultDiv = document.getElementById('result');
        const loading = document.getElementById('loading');

        roomInfoDiv.innerHTML = '';
        resultDiv.innerHTML = '';
        destroyPlayer();
        loading.classList.remove('is-hidden');

        try {
            const res = await fetch('/api/getStreamUrls', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ roomId })
            });
            const data = await res.json();
            loading.classList.add('is-hidden');

            if (data.error) {
                roomInfoDiv.innerHTML = `<div class="notification is-danger">${data.message}</div>`;
                return;
            }

            const { room_info, streams } = data;
            let statusClass = 'status-off';
            if (room_info.is_live) statusClass = 'status-live';
            else if (room_info.live_status === 2) statusClass = 'status-replay';

            // æ˜¾ç¤ºæˆ¿é—´ä¿¡æ¯
            roomInfoDiv.innerHTML = `
                <div class="room-header">
                    <img src="${room_info.cover || 'https://i0.hdslb.com/bfs/live/new_room_cover/default.jpg'}" 
                         class="room-cover" alt="å°é¢">
                    <div>
                        <h4 class="title is-4">${room_info.title}</h4>
                        <p><strong>ä¸»æ’­ï¼š</strong>${room_info.uname}</p>
                        <p><strong>çŠ¶æ€ï¼š</strong><span class="${statusClass}">${room_info.status_text}</span></p>
                        <img src="${room_info.face || 'https://i0.hdslb.com/bfs/face/member/noface.jpg'}" 
                             class="avatar" alt="å¤´åƒ">
                    </div>
                </div>
            `;

            if (!room_info.is_live) {
                resultDiv.innerHTML = '<div class="notification is-warning">å½“å‰æœªç›´æ’­ï¼Œæ— æ³•è·å–æµåœ°å€</div>';
                return;
            }

            // æ˜¾ç¤ºæµåœ°å€ + æ’­æ”¾æŒ‰é’®
            let html = '<div class="box"><h5 class="title is-5">å¯ç”¨æµåœ°å€</h5>';
            const formats = [
                { key: 'flv', name: 'FLV', lib: 'flv.js' },
                { key: 'fmp4', name: 'FMP4 (HLS)', lib: 'hls.js' },
                { key: 'ts', name: 'HLS (TS)', lib: 'hls.js' }
            ];

            formats.forEach(fmt => {
                const stream = streams[fmt.key];
                if (stream) {
                    html += `
                        <p><strong>${fmt.name}</strong>ï¼ˆ${stream.label}ï¼‰
                            <button class="button is-small copy-btn" onclick="copyToClipboard('${stream.url}')">å¤åˆ¶</button>
                            <button class="button is-small is-success play-btn" 
                                onclick="play${fmt.lib === 'flv.js' ? 'FLV' : 'HLS'}('${stream.url}')">
                                æ’­æ”¾
                            </button>
                        </p>
                        <div class="stream-url">${stream.url}</div><hr>
                    `;
                } else {
                    html += `<p><strong>${fmt.name}</strong>ï¼šä¸å¯ç”¨</p><hr>`;
                }
            });

            html += '</div>';
            resultDiv.innerHTML = html;

            // æ·»åŠ æˆªå›¾æŒ‰é’®ï¼ˆä»…å½“æœ‰æµæ—¶ï¼‰
            document.getElementById('screenshotArea').innerHTML = `
                <button class="button is-info screenshot-btn" onclick="takeScreenshot()">ğŸ“¸ æˆªå›¾å½“å‰ç”»é¢</button>
                <small class="has-text-grey">ï¼ˆéœ€å…ˆæ’­æ”¾è§†é¢‘ï¼‰</small>
            `;

        } catch (err) {
            loading.classList.add('is-hidden');
            roomInfoDiv.innerHTML = `<div class="notification is-danger">è¯·æ±‚å¤±è´¥ï¼š${err.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
        }
    });

    document.getElementById('roomId').addEventListener('keypress', e => {
        if (e.key === 'Enter') document.getElementById('queryBtn').click();
    });

    // å°é¢ä¸æˆªå›¾ç›¸å…³åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', function() {
        const roomIdInput = document.getElementById('roomIdInput');
        const fetchBtn = document.getElementById('fetchBtn');
        const resultContainer = document.getElementById('resultContainer');
        const titleDisplay = document.getElementById('titleDisplay');
        const unameDisplay = document.getElementById('unameDisplay');
        const roomIdDisplay = document.getElementById('imageRoomIdDisplay');
        const statusDisplay = document.getElementById('statusDisplay');
        const statusIndicator = document.getElementById('statusIndicator');
        const liveTimeDisplay = document.getElementById('liveTimeDisplay');
        const coverImage = document.getElementById('coverImage');
        const screenshotImage = document.getElementById('screenshotImage');
        const messageContainer = document.getElementById('messageContainer');
        const loadingDiv = document.getElementById('imageLoading');
        const downloadCoverBtn = document.getElementById('downloadCoverBtn');
        const downloadScreenshotBtn = document.getElementById('downloadScreenshotBtn');
        const coverImageInfo = document.getElementById('coverImageInfo');
        const screenshotImageInfo = document.getElementById('screenshotImageInfo');
        
        function validateRoomId(roomId) {
            return /^\d+$/.test(roomId);
        }
        
        function showMessage(message, isError = false) {
            messageContainer.innerHTML = `
                <div class="${isError ? 'notification is-danger' : 'notification is-success'}">
                    ${message}
                </div>
            `;
        }
        
        function hideMessage() {
            messageContainer.innerHTML = '';
        }
        
        async function getLiveInfo(roomId) {
            if (!validateRoomId(roomId)) {
                showMessage('é”™è¯¯ï¼šç›´æ’­é—´IDå¿…é¡»æ˜¯æ•°å­—ï¼', true);
                return;
            }
            
            try {
                loadingDiv.style.display = 'block';
                resultContainer.style.display = 'none';
                hideMessage();
                
                const response = await fetch('/api/bilibili-live-info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ room_id: roomId })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTPé”™è¯¯! çŠ¶æ€ç : ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.code !== 0) {
                    throw new Error(`è·å–ç›´æ’­ä¿¡æ¯å¤±è´¥ï¼Œé”™è¯¯ç : ${data.code}, é”™è¯¯ä¿¡æ¯: ${data.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
                
                const liveInfo = data.data;
                const userCover = liveInfo.user_cover || '';
                const keyframe = liveInfo.keyframe || '';
                const title = liveInfo.title || `ç›´æ’­é—´${roomId}`;
                const uname = liveInfo.uname || 'æœªçŸ¥ä¸»æ’­';
                const actualRoomId = liveInfo.room_id || roomId;
                const liveStatus = liveInfo.live_status || 0;
                const liveTime = liveInfo.live_time || 'æœªå¼€æ’­';
                
                titleDisplay.textContent = title;
                unameDisplay.textContent = uname;
                roomIdDisplay.textContent = actualRoomId;
                
                let statusText = '';
                let statusClass = '';
                switch(liveStatus) {
                    case 1:
                        statusText = 'ç›´æ’­ä¸­';
                        statusClass = 'live';
                        break;
                    case 2:
                        statusText = 'è½®æ’­ä¸­';
                        statusClass = 'round';
                        break;
                    default:
                        statusText = 'æœªå¼€æ’­';
                        statusClass = 'offline';
                }
                statusDisplay.textContent = statusText;
                statusIndicator.className = `status-indicator ${statusClass}`;
                liveTimeDisplay.textContent = liveTime;
                
                if (userCover) {
                    coverImage.onload = function() {
                        coverImageInfo.textContent = `å°é¢å°ºå¯¸: ${this.naturalWidth} Ã— ${this.naturalHeight} åƒç´ `;
                    };
                    coverImage.onerror = function() {
                        coverImageInfo.textContent = 'å°é¢å›¾ç‰‡åŠ è½½å¤±è´¥';
                    };
                    coverImage.src = `/api/image-proxy?url=${encodeURIComponent(userCover)}`;
                    
                    downloadCoverBtn.onclick = () => {
                        window.open(`/api/download-cover?url=${encodeURIComponent(userCover)}&roomId=${actualRoomId}`, '_blank');
                        showMessage(`å°é¢å›¾ç‰‡æ­£åœ¨ä¸‹è½½: å°é¢_${actualRoomId}.jpg`);
                    };
                } else {
                    coverImageInfo.textContent = 'æœªæ‰¾åˆ°å°é¢å›¾ç‰‡';
                }
                
                if (keyframe) {
                    screenshotImage.onload = function() {
                        screenshotImageInfo.textContent = `æˆªå›¾å°ºå¯¸: ${this.naturalWidth} Ã— ${this.naturalHeight} åƒç´ `;
                    };
                    screenshotImage.onerror = function() {
                        screenshotImageInfo.textContent = 'æˆªå›¾åŠ è½½å¤±è´¥ï¼Œå¯èƒ½ç›´æ’­é—´æœªå¼€æ’­æˆ–æ²¡æœ‰æˆªå›¾';
                    };
                    screenshotImage.src = `/api/image-proxy?url=${encodeURIComponent(keyframe)}`;
                    
                    downloadScreenshotBtn.onclick = () => {
                        window.open(`/api/download-screenshot?url=${encodeURIComponent(keyframe)}&roomId=${actualRoomId}`, '_blank');
                        showMessage(`ç›´æ’­æˆªå›¾æ­£åœ¨ä¸‹è½½: æˆªå›¾_${actualRoomId}.jpg`);
                    };
                } else {
                    screenshotImageInfo.textContent = 'æœªæ‰¾åˆ°ç›´æ’­æˆªå›¾ï¼Œå¯èƒ½ç›´æ’­é—´æœªå¼€æ’­';
                }
                
                resultContainer.style.display = 'block';
                showMessage('ç›´æ’­ä¿¡æ¯è·å–æˆåŠŸï¼');
                
            } catch (error) {
                console.error('è·å–ç›´æ’­ä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯:', error);
                showMessage(`å‘ç”Ÿé”™è¯¯: ${error.message}`, true);
            } finally {
                loadingDiv.style.display = 'none';
            }
        }
        
        fetchBtn.addEventListener('click', function() {
            const roomId = roomIdInput.value.trim();
            if (!roomId) {
                showMessage('è¯·è¾“å…¥ç›´æ’­é—´IDï¼', true);
                return;
            }
            getLiveInfo(roomId);
        });
        
        roomIdInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                fetchBtn.click();
            }
        });
    });
</script>
</body>
</html>