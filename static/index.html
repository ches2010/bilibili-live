<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>B站直播工具集</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <style>
        .stream-url { word-break: break-all; font-size: 0.9em; margin-top: 6px; }
        .player-container { margin-top: 20px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #f5f5f5; }
        .player-video { width: 100%; max-height: 60vh; background: #000; }
        .copy-btn, .play-btn, .screenshot-btn, .download-btn { margin: 4px 4px 4px 0; }
        .room-header { display: flex; align-items: flex-start; gap: 20px; margin-top: 20px; }
        .room-cover { width: 240px; height: 135px; object-fit: cover; border-radius: 6px; }
        .avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; }
        .status-live { color: #48c774; font-weight: bold; }
        .status-off { color: #ff3860; }
        .status-replay { color: #ffdd57; }
        footer { margin-top: 30px; text-align: center; color: #888; font-size: 0.9em; }
        .section-title { margin-top: 30px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
        .images-container { display: flex; flex-wrap: wrap; gap: 30px; margin-top: 20px; }
        .image-section { flex: 1; min-width: 300px; text-align: center; }
        .live-image { max-width: 100%; max-height: 500px; border-radius: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin: 0 auto; display: block; }
        .image-info { margin-top: 10px; font-size: 14px; color: #666; }
        .status-indicator { display: inline-block; padding: 5px 10px; border-radius: 15px; font-size: 14px; font-weight: bold; margin-left: 10px; }
        .live { background-color: #e74c3c; color: white; }
        .offline { background-color: #95a5a6; color: white; }
        .round { background-color: #f39c12; color: white; }
        .info-box { margin-top: 20px; padding: 15px; border-radius: 6px; background-color: #f9f9f9; }
    </style>
</head>
<body>
<div class="container">
    <section class="section">
        <h1 class="title is-3 has-text-centered">B站直播工具集</h1>
        
        <!-- 统一输入区域 -->
        <div class="field has-addons">
            <div class="control is-expanded">
                <input id="roomId" class="input" type="text" placeholder="输入直播间号码，例如：21574414" />
            </div>
            <div class="control">
                <button id="queryBtn" class="button is-primary">查询直播信息</button>
            </div>
        </div>

        <div id="loading" class="is-hidden mt-3">
            <progress class="progress is-small is-info" max="100"></progress>
        </div>

        <!-- 房间基本信息 -->
        <div id="roomInfo" class="mt-4"></div>

        <!-- 直播流播放区域 -->
        <h2 class="title is-4 section-title">直播流播放</h2>
        <div id="streamResult" class="mt-2"></div>
        <div id="playerArea" class="mt-4"></div>
        <div id="screenshotArea" class="mt-4"></div>

        <!-- 封面与截图区域 -->
        <h2 class="title is-4 section-title">封面与截图</h2>
        <div id="imageMessage" class="mt-2"></div>
        
        <div class="info-box">
            <div class="info-item">
                <strong>直播间标题:</strong> <span id="titleDisplay">-</span>
            </div>
            <div class="info-item">
                <strong>主播用户名:</strong> <span id="unameDisplay">-</span>
            </div>
            <div class="info-item">
                <strong>直播状态:</strong> 
                <span id="statusDisplay">-</span>
                <span id="statusIndicator" class="status-indicator"></span>
            </div>
            <div class="info-item">
                <strong>开播时间:</strong> <span id="liveTimeDisplay">-</span>
            </div>
        </div>
        
        <div class="images-container">
            <!-- 封面图片区域 -->
            <div class="image-section">
                <div class="image-title">直播间封面</div>
                <img id="coverImage" class="live-image" alt="直播封面" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 150' %3E%3Crect width='200' height='150' fill='%23eee'/%3E%3Ctext x='100' y='80' font-family='Arial' font-size='14' text-anchor='middle' fill='%23999'%3E等待加载...%3C/text%3E%3C/svg%3E">
                <div class="image-info" id="coverImageInfo"></div>
                <button class="button is-info download-btn" id="downloadCoverBtn" disabled>下载封面</button>
            </div>
            
            <!-- 直播截图区域 -->
            <div class="image-section">
                <div class="image-title">当前直播画面截图</div>
                <img id="screenshotImage" class="live-image" alt="直播截图" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 150' %3E%3Crect width='200' height='150' fill='%23eee'/%3E%3Ctext x='100' y='80' font-family='Arial' font-size='14' text-anchor='middle' fill='%23999'%3E等待加载...%3C/text%3E%3C/svg%3E">
                <div class="image-info" id="screenshotImageInfo"></div>
                <button class="button is-info download-btn" id="downloadScreenshotBtn" disabled>下载截图</button>
            </div>
        </div>
    </section>

    <footer>
        <p>💡 输入房间号后点击查询，即可获取所有相关信息</p>
    </footer>
</div>

<!-- 播放器库 -->
<script src="https://cdn.jsdelivr.net/npm/flv.js@1.5.1/dist/flv.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.10/dist/hls.min.js"></script>
<script>
    // 全局变量
    let currentPlayer = null;
    let currentVideo = null;
    let currentRoomId = null;
    let currentCoverUrl = null;
    let currentScreenshotUrl = null;

    // 销毁播放器
    function destroyPlayer() {
        if (currentPlayer) {
            if (typeof currentPlayer.destroy === 'function') currentPlayer.destroy();
            currentPlayer = null;
        }
        currentVideo = null;
        document.getElementById('playerArea').innerHTML = '';
    }

    // 播放FLV流
    function playFLV(url) {
        destroyPlayer();
        const container = document.getElementById('playerArea');
        const video = document.createElement('video');
        video.className = 'player-video';
        video.controls = true;
        video.playsInline = true;
        video.muted = false;
        currentVideo = video;

        const box = document.createElement('div');
        box.className = 'player-container';
        box.innerHTML = '<strong>正在播放 FLV 流</strong>';
        box.appendChild(video);
        container.appendChild(box);

        if (flvjs.isSupported()) {
            const player = flvjs.createPlayer({ type: 'flv', url });
            player.attachMediaElement(video);
            player.load();
            player.play().catch(e => console.warn('播放被阻止:', e));
            currentPlayer = player;
        } else {
            alert('浏览器不支持 FLV');
        }
    }

    // 播放HLS流
    function playHLS(url) {
        destroyPlayer();
        const container = document.getElementById('playerArea');
        const video = document.createElement('video');
        video.className = 'player-video';
        video.controls = true;
        video.playsInline = true;
        video.muted = false;
        currentVideo = video;

        const box = document.createElement('div');
        box.className = 'player-container';
        box.innerHTML = '<strong>正在播放 HLS 流</strong>';
        box.appendChild(video);
        container.appendChild(box);

        if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(url);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(e => console.warn('播放被阻止:', e)));
            currentPlayer = hls;
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = url;
            video.addEventListener('loadedmetadata', () => video.play().catch(e => console.warn('播放被阻止:', e)));
            currentPlayer = { destroy: () => video.src = '' };
        } else {
            alert('浏览器不支持 HLS');
        }
    }

    // 视频截图
    function takeScreenshot() {
        if (!currentVideo || currentVideo.readyState < 2) {
            alert('请先播放视频并等待加载！');
            return;
        }

        const canvas = document.createElement('canvas');
        canvas.width = currentVideo.videoWidth;
        canvas.height = currentVideo.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(currentVideo, 0, 0, canvas.width, canvas.height);

        canvas.toBlob(blob => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bili-live-${currentRoomId}-${Date.now()}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 'image/png');
    }

    // 复制到剪贴板
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => alert('已复制！')).catch(() => alert('复制失败'));
    }

    // 显示消息
    function showMessage(elementId, message, isError = false) {
        document.getElementById(elementId).innerHTML = `
            <div class="${isError ? 'notification is-danger' : 'notification is-success'}">
                ${message}
            </div>
        `;
    }

    // 清除消息
    function clearMessage(elementId) {
        document.getElementById(elementId).innerHTML = '';
    }

    // 查询按钮事件
    document.getElementById('queryBtn').addEventListener('click', async () => {
        const roomId = document.getElementById('roomId').value.trim();
        if (!roomId) return alert('请输入房间号');

        // 重置所有区域
        document.getElementById('roomInfo').innerHTML = '';
        document.getElementById('streamResult').innerHTML = '';
        clearMessage('imageMessage');
        destroyPlayer();
        document.getElementById('screenshotArea').innerHTML = '';
        document.getElementById('downloadCoverBtn').disabled = true;
        document.getElementById('downloadScreenshotBtn').disabled = true;
        
        // 显示加载状态
        document.getElementById('loading').classList.remove('is-hidden');
        currentRoomId = roomId;

        try {
            // 并行请求两个接口
            const [streamResponse, imageResponse] = await Promise.all([
                fetch('/api/getStreamUrls', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roomId })
                }),
                fetch('/api/bilibili-live-info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ room_id: roomId })
                })
            ]);

            // 解析直播流数据
            const streamData = await streamResponse.json();
            // 解析封面截图数据
            const imageData = await imageResponse.json();

            // 处理房间基本信息
            if (!streamData.error && streamData.room_info) {
                const room_info = streamData.room_info;
                let statusClass = 'status-off';
                if (room_info.is_live) statusClass = 'status-live';
                else if (room_info.live_status === 2) statusClass = 'status-replay';

                document.getElementById('roomInfo').innerHTML = `
                    <div class="room-header">
                        <img src="${room_info.cover || 'https://i0.hdslb.com/bfs/live/new_room_cover/default.jpg'}" 
                             class="room-cover" alt="封面">
                        <div>
                            <h4 class="title is-4">${room_info.title}</h4>
                            <p><strong>主播：</strong>${room_info.uname}</p>
                            <p><strong>状态：</strong><span class="${statusClass}">${room_info.status_text}</span></p>
                            <img src="${room_info.face || 'https://i0.hdslb.com/bfs/face/member/noface.jpg'}" 
                                 class="avatar" alt="头像">
                        </div>
                    </div>
                `;
            }

            // 处理直播流信息
            if (streamData.error) {
                showMessage('streamResult', streamData.message, true);
            } else {
                const { room_info, streams } = streamData;
                
                if (!room_info.is_live) {
                    showMessage('streamResult', '当前未直播，无法获取流地址', false);
                } else {
                    let html = '<div class="box"><h5 class="title is-5">可用流地址</h5>';
                    const formats = [
                        { key: 'flv', name: 'FLV', lib: 'flv.js' },
                        { key: 'fmp4', name: 'FMP4 (HLS)', lib: 'hls.js' },
                        { key: 'ts', name: 'HLS (TS)', lib: 'hls.js' }
                    ];

                    formats.forEach(fmt => {
                        const stream = streams[fmt.key];
                        if (stream) {
                            html += `
                                <p><strong>${fmt.name}</strong>（${stream.label}）
                                    <button class="button is-small copy-btn" onclick="copyToClipboard('${stream.url}')">复制</button>
                                    <button class="button is-small is-success play-btn" 
                                        onclick="play${fmt.lib === 'flv.js' ? 'FLV' : 'HLS'}('${stream.url}')">
                                        播放
                                    </button>
                                </p>
                                <div class="stream-url">${stream.url}</div><hr>
                            `;
                        } else {
                            html += `<p><strong>${fmt.name}</strong>：不可用</p><hr>`;
                        }
                    });

                    html += '</div>';
                    document.getElementById('streamResult').innerHTML = html;
                    
                    // 添加截图按钮
                    document.getElementById('screenshotArea').innerHTML = `
                        <button class="button is-info screenshot-btn" onclick="takeScreenshot()">📸 截图当前画面</button>
                        <small class="has-text-grey">（需先播放视频）</small>
                    `;
                }
            }

            // 处理封面和截图信息
            if (imageData.code !== 0) {
                showMessage('imageMessage', `获取封面截图失败: ${imageData.message || '未知错误'}`, true);
            } else {
                const liveInfo = imageData.data;
                currentCoverUrl = liveInfo.user_cover || '';
                currentScreenshotUrl = liveInfo.keyframe || '';
                
                // 更新信息显示
                document.getElementById('titleDisplay').textContent = liveInfo.title || `直播间${roomId}`;
                document.getElementById('unameDisplay').textContent = liveInfo.uname || '未知主播';
                document.getElementById('liveTimeDisplay').textContent = liveInfo.live_time || '未开播';
                
                // 更新状态显示
                let statusText = '';
                let statusClass = '';
                switch(liveInfo.live_status || 0) {
                    case 1:
                        statusText = '直播中';
                        statusClass = 'live';
                        break;
                    case 2:
                        statusText = '轮播中';
                        statusClass = 'round';
                        break;
                    default:
                        statusText = '未开播';
                        statusClass = 'offline';
                }
                document.getElementById('statusDisplay').textContent = statusText;
                document.getElementById('statusIndicator').className = `status-indicator ${statusClass}`;
                
                // 处理封面图片
                if (currentCoverUrl) {
                    const coverImg = document.getElementById('coverImage');
                    coverImg.onload = function() {
                        document.getElementById('coverImageInfo').textContent = 
                            `封面尺寸: ${this.naturalWidth} × ${this.naturalHeight} 像素`;
                    };
                    coverImg.onerror = function() {
                        document.getElementById('coverImageInfo').textContent = '封面图片加载失败';
                    };
                    coverImg.src = `/api/image-proxy?url=${encodeURIComponent(currentCoverUrl)}`;
                    
                    // 启用下载按钮
                    document.getElementById('downloadCoverBtn').disabled = false;
                    document.getElementById('downloadCoverBtn').onclick = () => {
                        window.open(`/api/download-cover?url=${encodeURIComponent(currentCoverUrl)}&roomId=${roomId}`, '_blank');
                        showMessage('imageMessage', `封面图片正在下载: 封面_${roomId}.jpg`);
                    };
                } else {
                    document.getElementById('coverImageInfo').textContent = '未找到封面图片';
                }
                
                // 处理截图
                if (currentScreenshotUrl) {
                    const screenshotImg = document.getElementById('screenshotImage');
                    screenshotImg.onload = function() {
                        document.getElementById('screenshotImageInfo').textContent = 
                            `截图尺寸: ${this.naturalWidth} × ${this.naturalHeight} 像素`;
                    };
                    screenshotImg.onerror = function() {
                        document.getElementById('screenshotImageInfo').textContent = '截图加载失败，可能直播间未开播';
                    };
                    screenshotImg.src = `/api/image-proxy?url=${encodeURIComponent(currentScreenshotUrl)}`;
                    
                    // 启用下载按钮
                    document.getElementById('downloadScreenshotBtn').disabled = false;
                    document.getElementById('downloadScreenshotBtn').onclick = () => {
                        window.open(`/api/download-screenshot?url=${encodeURIComponent(currentScreenshotUrl)}&roomId=${roomId}`, '_blank');
                        showMessage('imageMessage', `直播截图正在下载: 截图_${roomId}.jpg`);
                    };
                } else {
                    document.getElementById('screenshotImageInfo').textContent = '未找到直播截图，可能直播间未开播';
                }
            }

        } catch (err) {
            showMessage('streamResult', `请求失败：${err.message || '未知错误'}`, true);
            showMessage('imageMessage', `请求失败：${err.message || '未知错误'}`, true);
        } finally {
            document.getElementById('loading').classList.add('is-hidden');
        }
    });

    // 回车查询
    document.getElementById('roomId').addEventListener('keypress', e => {
        if (e.key === 'Enter') document.getElementById('queryBtn').click();
    });
</script>
</body>
</html>